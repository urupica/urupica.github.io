<!DOCTYPE html>
<html>
  <head>
    <title>Geolocation</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 60%;
      }
      #data {
	      height: 40%;
      }
    </style>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
   <!--<script src="js/ion.sound.js"></script>-->
   </head>
  <body>
    <div id="map"></div>
    <div id="data">
		<button onclick="loadSounds()">Load Sounds</button><br/>
	    Location: <span id="loc"></span><br/>
	    Accuracy: <span id="acc"></span><br/>	    
	    Altitude: <span id="alt"></span><br/>
		Heading: <span id="head"></span><br/>
    	Speed: <span id="speed"></span><br/>
		Last update: <span id="time">No update yet</span><br/>
		Debug: <span id="debug"></span><br/>
		<button onclick="startRun()">Start!</button>
    </div>
    <audio id="audioBeep" preload="auto">
	    <source src="sounds/beep.ogg" type="audio/ogg">
	    <source src="sounds/beep.mp3" type="audio/mp3">
	    <source src="sounds/beep.m4a" type="audio/mpeg">
	    Your browser does not support the audio tag.
    </audio>
    <audio id="audioSlow" preload="auto">
	    <source src="sounds/slow.ogg" type="audio/ogg">
	    <source src="sounds/slow.mp3" type="audio/mp3">
	    <source src="sounds/slow.m4a" type="audio/mpeg">
	    Your browser does not support the audio tag.
    </audio>
    <audio id="audioGood" preload="auto">
	    <source src="sounds/good.ogg" type="audio/ogg">
	    <source src="sounds/good.mp3" type="audio/mp3">
	    <source src="sounds/good.m4a" type="audio/mpeg">
	    Your browser does not support the audio tag.
    </audio>
    <audio id="audioFast" preload="auto">
	    <source src="sounds/fast.ogg" type="audio/ogg">
	    <source src="sounds/fast.mp3" type="audio/mp3">
	    <source src="sounds/fast.m4a" type="audio/mpeg">
	    Your browser does not support the audio tag.
    </audio>
    <script>
      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.

      //var infoWindow;
      var redDot;
      var blueDot;
      var map;
      var mapPositioned;
      var seconds;
      var timer;
      var totalTime = 25*1000;
      var totalLength;
      var loopHome;
      var polyline;
      var startTime;
      //var t;

      var home = { lat:-16.5219558,  lng:-68.06559969999999};

      function initMap() {

		/*
        ion.sound({
            sounds: [
                {name: "slow"},
                {name: "good"},
                {name: "fast"},
                {name: "beep"}
            ],
            path: "sounds/",
            preload: true,
            volume: 1.0
        });
        */



        map = new google.maps.Map(document.getElementById('map'), {
          	center: home,
          	zoom: 15
        });

        loopHome = [
			{lat: -16.52194681423197, lng: -68.06489598709584},
			{lat: -16.52184508166221, lng: -68.06463747278261},
			{lat: -16.52159571388442, lng: -68.06427077677976},
			{lat: -16.52139693876164, lng: -68.06403276908758},
			{lat: -16.52060402582187, lng: -68.06343841909319},
			{lat: -16.52005410985657, lng: -68.06313053093483},
			{lat: -16.51964930609482, lng: -68.06385953370396},
			{lat: -16.52030651834609, lng: -68.06421685238097},
			{lat: -16.52079704118083, lng: -68.06453877286083},
			{lat: -16.52103052481336, lng: -68.06473373885925},
			{lat: -16.52119910752698, lng: -68.06502206586399},
			{lat: -16.5212686141782, lng: -68.06556641264461},
			{lat: -16.52213622700845, lng: -68.06554257126746},
			{lat: -16.52195443635513, lng: -68.06493704474225}
  		];


  		polyline = new google.maps.Polyline({
    		path: loopHome,
    		strokeColor: '#000000',
    		strokeOpacity: 1.0,
    		strokeWeight: 3
  		});

	  	polyline.setMap(map);

  		totalLength = computeTotalLength();

        //infoWindow = new google.maps.InfoWindow({map: map});
        redDot = new google.maps.Marker({
          map: map,
          icon: 'images/redDot.png',
          position: home
        });
        blueDot = new google.maps.Marker({
          map: map,
          icon: 'images/blueDot.png',
          position: loopHome[0]
        });

		mapPositioned = false;
		seconds = null;
		timer = null;

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
	  		//updateLocation();

			options = {
  				enableHighAccuracy: true,
  				timeout: 1000,
  				maximumAge: 0
			};

	  		var watchLocation = navigator.geolocation.watchPosition(updateMapAndData, error, options);
        } else {
          	// Browser doesn't support Geolocation
          	handleLocationError(false, infoWindow, map.getCenter());
        }

        //t = 0;
      }

	function startTimer() {
		if(seconds == 0) {
	    		$("#time").text("Just updated");
		} else {
	    		$("#time").text(seconds + " second" + (seconds == 1 ? "" : "s") + " ago");
		}
		seconds += 1;
		timer = setTimeout(startTimer, 1000);
	}

	function stopTimer() {
		seconds = null;
		if(timer != null) { 
			clearTimeout(timer);
		}
	}

	function computeTotalLength() {
		//return google.maps.geometry.spherical.computeLength(loopHome);
		return google.maps.geometry.spherical.computeLength(polyline.getPath().getArray());
	}

	function startRun() {
		startTime = Date.now();
        run();
	}

	function run() {
		var t = Date.now() - startTime;
		moveBlueDot(t);
		//t += 100;
		if(t < totalTime) {
			setTimeout(run, 1000);
		}
	}

	function moveBlueDot(t) {
		if(t >= totalTime) {
			blueDot.setPosition(loopHome[loopHome.length - 1]);
		} else {
			var pace = totalTime/totalLength;
			var time = 0;
			var array = polyline.getPath().getArray();
			i = 1;
			var partialDistance = google.maps.geometry.spherical.computeDistanceBetween(array[0], array[1]);
			var partialTime = partialDistance*pace;
			while(time + partialTime <= t) {
				time += partialTime;
				i++;
				if(i >= loopHome.length) {
					break;
				}
				partialDistance = google.maps.geometry.spherical.computeDistanceBetween(array[i-1], array[i]);
				partialTime = partialDistance*pace;
			}
			d = (t - time)/partialTime;
			var lat = d*loopHome[i].lat + (1-d)*loopHome[i-1].lat;
			var lng = d*loopHome[i].lng + (1-d)*loopHome[i-1].lng;
			var position = {lat:lat, lng:lng};
			blueDot.setPosition(position);
		}
	}

	/*
      function updateLocation() {
          navigator.geolocation.getCurrentPosition(updateMapAndData, handleLocationError, setOptions);
	  setTimeout(updateLocation ,100);
      }
      */

	/*
	function setOptions(geoLoc) {
            geoLoc.enableHighAccuracy = true;
            geoLoc.timeout = 30;
            geoLoc.maximumAge = 0;
        }
	*/

	function error(err) {
	    $("#loc").text("");
	    $("#acc").text("");
	    $("#alt").text("");
	    $("#head").text("");
	    $("#speed").text("");
	    $("#time").text("");
		$("#debug").text('ERROR(' + err.code + '): ' + err.message + ". Have some patience...");
	}


	function updateMapAndData(position) {
		$("#audioBeep").get(0).play();
	    //ion.sound.play("beep");
        var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        redDot.setPosition(pos);
        //infoWindow.setPosition(pos);
        //infoWindow.setContent('You are here.');
	    map.setCenter(pos);
	    /*
	    if(!mapPositioned) {
	            map.setCenter(pos);
			mapPositioned = true;
		}
		*/
	    $("#loc").text("lat: " + position.coords.latitude + ", lon: " + position.coords.longitude);
	    $("#acc").text(Math.round(position.coords.accuracy) + " m");
	    var altitudeString = "";
	    if(position.coords.altitude == null) {
		altitudeString += "No data";
	    } else {
		    altitudeString += Math.round(position.coords.altitude);
	    	if(position.coords.altitudeAccuracy == null) {
			altitudeString += "(accuracy: No data)";
		} else {
			altitudeString += " (accuracy: " + position.coords.altitudeAccuracy + ")"
		}
	    }
	    $("#alt").text(altitudeString);
	    if(isNaN(position.coords.heading)) {
	    	$("#head").text("No data");
	    } else {
		    var dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];

		    for(i=0; i<9; i++) {
			    if(position.coords.heading < 22.5 + 45*i) {
	    			$("#head").text(dirs[i%8]);
				break;
			    }
		    }
	    }
	    if(isNaN(position.coords.speed) || position.coords.speed == null) {
	    	$("#speed").text("No data");
	    } else {
	    	$("#speed").text(position.coords.speed + "m/s");
		
		if(position.coords.speed < 0.75) {
			//var audio = new Audio('slow.ogg');
			//audio.play();
			$("#audioSlow").get(0).play();
			//ion.sound.play("slow");
		} else if(position.coords.speed <= 1.25) { 
			//var audio = new Audio('good.ogg');
			//audio.play();
			$("#audioGood").get(0).play();
			//ion.sound.play("good");
		} else {
			//var audio = new Audio('fast.ogg');
			//audio.play();
			$("#audioFast").get(0).play();
			//ion.sound.play("fast");
		}
		
	    }
	    stopTimer();
	    seconds = 0;
	    startTimer();
	    /*
	    if(isNaN(position.timestamp) || position.timestamp == null) {
	    	$("#time").text("No data");
	    } else {
		    if(timestamp == null) {
	    		$("#time").text("First time");
		    } else {
	    		$("#time").text(Math.round((position.timestamp - timestamp)/1000) + " seconds ago");
			timestamp = position.timestamp;
		    }
	    }
	    */
	    $("#debug").text("All seems OK");
	}

	function loadSounds() {
		//alert("beep");
		//$("#audioBeep").get(0).play();
		$("#audioSlow").get(0).load();
		$("#audioGood").get(0).load();
		$("#audioFast").get(0).load();
		$("#audioBeep").get(0).load();

		//ion.sound.play("beep");
	}

      function handleLocationError(pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=geometry">
    </script>
  </body>
</html>
